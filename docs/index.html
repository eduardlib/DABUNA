<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מדד אמינות ועקביות (חי)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; background:#0e1522; color:#eef1f6; }
    h1 { margin: 0 0 8px; }
    .muted { color:#95a1b2; font-size:.9rem }
    .grid { display:grid; grid-template-columns: 1fr 2fr; gap: 16px; }
    .card { background:#0b1120; border:1px solid #1f2a44; border-radius:12px; padding:16px; }
    table { width:100%; border-collapse: collapse; }
    th,td { border-bottom:1px solid #1f2a44; padding:8px; text-align:right; }
    th { color:#9fb4d6; font-weight:600; }
    input[type="search"]{width:100%; padding:12px; border-radius:10px; border:1px solid #1f2a44; background:#0b1120; color:#eef1f6;}
    .row { display:flex; gap:12px; align-items:center; justify-content:flex-start; margin-top:10px }
    .btn { padding:10px 14px; border-radius:10px; border:1px solid #1f2a44; background:#112042; color:#dfe8fa; text-decoration:none; }
    .btn:hover { filter: brightness(1.1); }
    .empty { text-align:center; color:#9fb4d6; padding:24px; }
  </style>
</head>
<body>
  <h1>מדד אמינות ועקביות (חי)</h1>
  <div class="muted"><span id="last-updated">—</span> • <span id="count">רשומות 0</span></div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <input id="q" type="search" placeholder="חיפוש לפי שם/מפלגה/תפקיד…" />
      <table id="tbl" style="margin-top:12px">
        <thead>
          <tr><th>תפקיד</th><th>מפלגה</th><th>שם</th><th>INDEX</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="tbl-empty" class="empty" style="display:none">אין נתונים להצגה.</div>
    </div>

    <div class="card">
      <canvas id="chart" height="240"></canvas>
      <div class="muted">לחיצה על שם בטבלה תציג את הערך בגרף. אם אין היסטוריה, יוצג תרשים עמודות של הטופ-10 הנוכחי.</div>
      <div class="row">
        <a class="btn" id="btn-share" target="_blank">שתפו 🔗</a>
        <a class="btn" id="btn-news" target="_blank">ערוץ החדשות 📰</a>
        <a class="btn" id="btn-index" target="_blank">ערוץ המדד 📊</a>
      </div>
    </div>
  </div>

<script>
const URL_LATEST = "./latest_scores.json";   // שים לב לנתיב יחסי (Project Pages)
const URL_HISTORY = "./history_scores.json";

const DASH_URL = "https://eduardlib.github.io/DABUNA/";
const NEWS_CH = "https://t.me/DabunaNews";
const RATING_CH = "https://t.me/DabunaRating";

// עזרה: ממפה אובייקט/מערך לשורה אחת עם שמות שדות עקביים
function normalizeRows(objOrArr){
  // latest יכול להיות {date, rows:[...]} או פשוט [...]. מנרמלים:
  let rows = Array.isArray(objOrArr) ? objOrArr : (objOrArr?.rows || []);
  return rows.map(r => ({
    name: r.name || r.Name || "",
    party: r.party || r.Party || "",
    role: r.role || r.Role || "",
    index: Number(r.IndexScore ?? r.index ?? r.score ?? 0),
    consistency: Number(r.Consistency ?? r.consistency ?? 0),
    fact: Number(r.FactIntegrity ?? r.fact ?? 0),
    trans: Number(r.Transparency ?? r.trans ?? 0),
  }));
}

function normalizeHistory(historyJson){
  // history: {"days":[{"date":"YYYY-MM-DD","rows":[...]}, ...]}
  const out = {};
  const days = historyJson?.days || [];
  for(const d of days){
    const date = d.date || "";
    const rows = normalizeRows(d);
    rows.forEach(r=>{
      const key = r.name || "";
      out[key] = out[key] || [];
      out[key].push({date, index:r.index});
    });
  }
  // מיין לפי תאריך
  for(const k in out){ out[k].sort((a,b)=>a.date.localeCompare(b.date)); }
  return out;
}

let LATEST = [];
let HIST = {};
let chart;

function setButtons(){
  document.querySelector("#btn-share").href = "https://t.me/share/url?url="+encodeURIComponent(DASH_URL);
  document.querySelector("#btn-news").href = NEWS_CH;
  document.querySelector("#btn-index").href = RATING_CH;
}

async function loadData(){
  const [a,b] = await Promise.all([
    fetch(URL_LATEST).then(r=>r.json()).catch(()=>({rows:[]})),
    fetch(URL_HISTORY).then(r=>r.json()).catch(()=>({days:[]})),
  ]);
  // עדכון טקסט עליון
  const date = a?.date || (new Date()).toISOString();
  document.querySelector("#last-updated").textContent = new Date(date).toLocaleString("he-IL");

  LATEST = normalizeRows(a);
  HIST = normalizeHistory(b);

  document.querySelector("#count").textContent = "רשומות " + LATEST.length;

  renderTable(LATEST);
  renderChartInitial();
}

function renderTable(rows){
  const tb = document.querySelector("#tbl tbody");
  const empty = document.querySelector("#tbl-empty");
  tb.innerHTML = "";
  if(!rows.length){ empty.style.display="block"; return; }
  empty.style.display="none";
  rows.slice(0, 100).forEach(r=>{
    const tr = document.createElement("tr");
    const nameCell = `<a href="#" data-name="${r.name}" class="rowlink" style="color:#e5f2ff;text-decoration:underline">${r.name}</a>`;
    tr.innerHTML = `<td>${r.role}</td><td>${r.party}</td><td>${nameCell}</td><td>${r.index.toFixed(0)}</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll(".rowlink").forEach(a=>{
    a.addEventListener("click",(ev)=>{
      ev.preventDefault();
      const nm = a.getAttribute("data-name");
      renderChartForPerson(nm);
    });
  });
}

function destroyChart(){ if(chart){ chart.destroy(); chart=null; } }

function renderChartInitial(){
  // אם יש היסטוריה – נצייר קו לזו עם הכי הרבה נקודות, אחרת עמודות לטופ-10 נוכחי
  const names = Object.keys(HIST);
  if(names.length){
    // מצא את האדם עם הכי הרבה נקודות
    names.sort((x,y)=>HIST[y].length - HIST[x].length);
    renderChartForPerson(names[0]);
  }else{
    const top = [...LATEST].sort((a,b)=>b.index-a.index).slice(0,10);
    destroyChart();
    const ctx = document.getElementById("chart").getContext("2d");
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: top.map(r=>r.name),
        datasets: [{ label: "Index", data: top.map(r=>r.index) }]
      },
      options: { responsive:true, maintainAspectRatio:false,
        scales:{ y:{ suggestedMin:0, suggestedMax:100 } }
      }
    });
  }
}

function renderChartForPerson(name){
  const series = HIST[name] || [];
  if(!series.length){
    // אין היסטוריה – הצג עמודה בודדת מהנתון האחרון (אם קיים)
    const found = LATEST.find(r=>r.name===name);
    destroyChart();
    const ctx = document.getElementById("chart").getContext("2d");
    chart = new Chart(ctx, {
      type: "bar",
      data: { labels: [name], datasets:[{label:"Index", data:[found?found.index:0]}] },
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ suggestedMin:0, suggestedMax:100 } } }
    });
    return;
  }
  destroyChart();
  const ctx = document.getElementById("chart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: series.map(p=>p.date),
      datasets: [{ label: name, data: series.map(p=>p.index), tension:0.3 }]
    },
    options: { responsive:true, maintainAspectRatio:false,
      scales:{ y:{ suggestedMin:0, suggestedMax:100 } }
    }
  });
}

document.querySelector("#q").addEventListener("input", (e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q) return renderTable(LATEST);
  const rows = LATEST.filter(r =>
    (r.name||"").toLowerCase().includes(q) ||
    (r.party||"").toLowerCase().includes(q) ||
    (r.role||"").toLowerCase().includes(q)
  );
  renderTable(rows);
});

setButtons();
loadData();
</script>
</body>
</html>
